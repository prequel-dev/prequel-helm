apiVersion: v1
kind: ServiceAccount
metadata:
  namespace: {{ .Release.Namespace }}
  name: prequel-provision
---
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  name: prequel-provision
  namespace: {{ .Release.Namespace }}
  labels:
    helm.sh/chart: "{{ .Chart.Name }}-{{ .Chart.Version }}"
rules:
- apiGroups:
  - ""
  resources:
  - secrets
  verbs:
  - create
  - update
  - list
  - get
  - delete
---
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  name: prequel-provision
  namespace: {{ .Release.Namespace }}
  labels:
    helm.sh/chart: "{{ .Chart.Name }}-{{ .Chart.Version }}"
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: Role
  name: prequel-provision
subjects:
- kind: ServiceAccount
  name: prequel-provision
  namespace: {{ .Release.Namespace }}
---
apiVersion: batch/v1
kind: Job
metadata:
  name: prequel-install
  labels:
    app.kubernetes.io/managed-by: {{ .Release.Service | quote }}
    app.kubernetes.io/instance: {{ .Release.Name | quote }}
    app.kubernetes.io/version: {{ .Chart.AppVersion }}
    helm.sh/chart: "{{ .Chart.Name }}-{{ .Chart.Version }}"
spec:
  ttlSecondsAfterFinished: 120 
  template:
    metadata:
      name: "{{ .Release.Name }}"
      labels:
        app.kubernetes.io/managed-by: {{ .Release.Service | quote }}
        app.kubernetes.io/instance: {{ .Release.Name | quote }}
        helm.sh/chart: "{{ .Chart.Name }}-{{ .Chart.Version }}"
    spec:
      restartPolicy: OnFailure
      serviceAccountName: prequel-provision
      tolerations:
        {{- toYaml .Values.provision.tolerations | nindent 8 }}
      containers:
      - name: prequel-provision
        image:  "{{ .Values.repository }}/{{ .Values.provision.image.repoName }}:{{ .Values.provision.image.tag | default .Chart.AppVersion }}"
        imagePullPolicy: {{ .Values.provision.image.pullPolicy }}
        command:
          - /app/prequel-provision
        args:
          - "install"
        env:
        - name: API_GATEWAY
          value: "{{ .Values.url }}"
        - name: CLUSTER_NAME
          value: "{{ .Values.clusterName }}"
        - name: PREQUEL_TOKEN
          value: "{{ .Values.token }}"
        - name: PREQUEL_TOKEN_NAME
          value: "{{ .Values.provision.tokenName }}"
        - name: PREQUEL_TOKEN_KEY
          value: "{{ .Values.provision.tokenKey }}"
      {{- with .Values.collector.nodeSelector }}
      nodeSelector:
        {{- toYaml . | nindent 8 }}
      {{- end }} {{- with .Values.collector.affinity }}
      affinity:
        {{- toYaml . | nindent 8 }}
      {{- end }}
